<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Settings</title>
  <link rel="stylesheet" href="/base.css">
  <link rel="stylesheet" href="/forum-ui.css">
</head>
<body>

<header class="topbar">
  <div class="left">
    <div class="brand">
      <div class="title">Settings</div>
      <div class="sub">Profile & appearance</div>
    </div>
  </div>
  <div class="right">
    <button class="btn-ghost" onclick="location.href='/forum.html'">Back</button>
    <button class="btn-ghost btn-danger" onclick="logout()">Logout</button>
  </div>
</header>

<main class="container page-pad">

  <section class="card set-card">
    <div class="set-row">
      <img id="preview" class="preview-avatar" alt="">
      <div class="grow">
        <div style="font-weight:900">Avatar</div>
        <div class="muted small">PNG/JPG/WEBP, до 1.5MB</div>
      </div>
    </div>

    <div class="hr"></div>

    <input type="file" id="avatarFile" class="input" accept="image/*">
    <button class="btn-soft" onclick="uploadAvatar()">Upload avatar</button>
    <div id="msgA" class="msg hidden"></div>
  </section>

  <section class="card set-card">
    <label class="label">Name</label>
    <input class="input" id="name">

    <label class="label">Username</label>
    <input class="input" id="username" placeholder="@username">

    <label class="label">About</label>
    <textarea class="textarea" id="about" style="min-height:110px"></textarea>

    <div class="hr"></div>

    <div class="muted small" style="margin-bottom:8px;">Badges</div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <label class="badge premium"><input type="checkbox" id="bPremium"> PREMIUM</label>
      <label class="badge verified"><input type="checkbox" id="bVerified"> VERIFIED</label>
      <label class="badge early"><input type="checkbox" id="bEarly"> EARLY</label>
    </div>

    <div class="hr"></div>

    <button class="btn" onclick="save()">Save</button>
    <div id="msg" class="msg hidden"></div>
  </section>

</main>

<script>
function show(el,t){ el.textContent=t; el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); el.textContent=""; }

async function getMe(){
  const r = await fetch("/api/auth?action=profile_get", { credentials:"include" });
  if (r.status===401) location.href="/index.html";
  return r.json().catch(()=>({ok:false}));
}

async function postAuth(action, data){
  const r = await fetch(`/api/auth?action=${encodeURIComponent(action)}`, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(data)
  });
  return r.json().catch(()=>({ok:false,error:"BAD_RESPONSE"}));
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(String(fr.result));
    fr.onerror=reject;
    fr.readAsDataURL(file);
  });
}

async function uploadAvatar(){
  hide(msgA);
  const f = avatarFile.files[0];
  if (!f) return show(msgA,"Choose file");
  if (f.size > 1.5*1024*1024) return show(msgA,"Too large (max 1.5MB)");

  const dataUrl = await fileToDataUrl(f);
  preview.src = dataUrl;

  const r = await postAuth("avatar_set", { dataUrl });
  if (!r.ok) return show(msgA, r.error || "Upload failed");
  show(msgA,"Avatar updated");
}

async function save(){
  hide(msg);
  const badges=[];
  if (bPremium.checked) badges.push("premium");
  if (bVerified.checked) badges.push("verified");
  if (bEarly.checked) badges.push("early");

  const r = await postAuth("profile_set", {
    name: name.value,
    username: username.value,
    about: about.value,
    badges
  });
  if (!r.ok) return show(msg, r.error || "Save failed");
  show(msg,"Saved");
}

async function logout(){
  await postAuth("logout", {});
  location.href="/index.html";
}

(async()=>{
  const me = await getMe();
  if (!me.ok) return location.href="/index.html";
  name.value = me.user.name || "";
  username.value = "@"+(me.user.username||"");
  about.value = me.user.about || "";
  if (me.user.avatar) preview.src = me.user.avatar; else preview.style.visibility="hidden";

  const s = new Set(me.user.badges || []);
  bPremium.checked = s.has("premium");
  bVerified.checked = s.has("verified");
  bEarly.checked = s.has("early");
})();
</script>

</body>
</html>
